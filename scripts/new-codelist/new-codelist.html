<html>

<head>
    <script src="d3.min.js"></script>
</head>

<body>
    <div id="constraint"></div>
    <div id="cypher"></div>
</body>

<script>
    let root = "codelist.csv"

    document.addEventListener("DOMContentLoaded", function () {

        d3.csv(root, function (data) {
            headerRow = Object.keys(data[0])
            codelist = headerRow["0"]
            label = headerRow["1"]
            let edition = prompt("Please enter edition (normally a year")

            let node = document.createElement("p");
            let textnode = document.createTextNode("CREATE CONSTRAINT ON (n:`_code_" + codelist +
                "`) ASSERT n.value IS UNIQUE;");
            node.appendChild(textnode);
            document.getElementById("constraint").appendChild(node);
            let node2 = document.createElement("p");
            let text = document.createTextNode("CREATE (node:`_code_list`:`_code_list_" + codelist +
                "` { label:'" +
                label + "', edition:'"+ edition +"' });");
            node2.appendChild(text);
            document.getElementById("cypher").appendChild(node2);
            if (label === "geography") {
                let unique = confirm(
                    "Are you loading geogrphy codes? This script will not create code-list specific nodes. Ensure all codes are globally unique"
                );
             if (unique == true) {
                    data.map(function (data) {
                        codeLabel = "geography"
                        createCodes(data, codeLabel)
                    })
                } else {
                    alert("Cancelled");
                }
            } else {
                data.map(function (data) {
                    codeLabel = codelist
                    createCodes(data, codeLabel)
                })
            }
        });
    })
    function createCodes(data) {
        let node = document.createElement("p");
        let textnode = document.createTextNode("MERGE (node:`_code`:`_code_" + codeLabel.trim() + "` { value:'" +
            data[
                codelist].trim() + "' });");
        node.appendChild(textnode);
        document.getElementById("cypher").appendChild(node);
        let node2 = document.createElement("p");
        let text = document.createTextNode("MATCH (parent:`_code_list`:`_code_list_" + codelist.trim() +
            "`),(node:`_code`:`_code_" + codelist.trim() + "` { value:'" + data[codelist].trim() +
            "' }) MERGE (node)-[:usedBy { label:\"" + data[
                label].trim() + "\"}]->(parent);");
        node2.appendChild(text);
        document.getElementById("cypher").appendChild(node2);
    }
</script>
</html>