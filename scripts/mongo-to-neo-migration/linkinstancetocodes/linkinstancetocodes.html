<html>

<body>
    <div id="cypher"></div>
</body>

<script>
    let root = "https://api.dev.cmd.onsdigital.co.uk/v1/datasets"
    // let root = "https://api.beta.ons.gov.uk/v1/datasets"
    // let root = "http://localhost:23200/v1/datasets"

    document.addEventListener("DOMContentLoaded", function () {
        fetch(root, {
                mode: 'cors'
            })
            .then(data => data.json())
            .then(function (data) {

                data.items.map(function (data) {

                    // console.log(data.links.latest_version.href)
                    latestVersion = data.links.latest_version.href
                    getVersion(latestVersion)
                })
            })
    })



    function getVersion(latestVersion) {
        fetch(latestVersion, {
                mode: 'cors'
            })
            .then(data => data.json())
            .then(function (data) {
                if (data.version > 2) {
                    // console.log (">1" + data.version + "name" + data.id)
                    for (i = data.version; i > 0; i--) {
                        // console.log (i)
                        // console.log (data.links.self.href)
                        version = data.links.self.href
                        version = version.replace(data.version, i)
                        fetch(version, {
                                mode: 'cors'
                            })
                            .then(data => data.json())
                            .then(function (data) {
                                instance = data.id
                                // console.log (instance)
                                data = data.links.self.href + "/dimensions"
                                // console.log (data.id)
                                dimensionOptions(data, instance)
                                // writeCypher (data)
                            })
                    }
                } else {
                    // console.log (latestVersion + " : " + data.id)
                    data = data.links.self.href + "/dimensions" + " : " + data.id
                    // dimensionOptions(data)
                    // writeCypher (data)
                }
            })
    }


    async function dimensionOptions(data, instance) {
        let dataset = data
        await fetch(dataset, {
                mode: 'cors'
            })
            .then(data => data.json())
            .then(function (data) {

                data.items.map(function (data) {
                    // console.log(dataset)
                    // console.log(data + "/" + data.dimension + "/options")

                    fetch(dataset + "/" + data.dimension + "/options", {
                            mode: 'cors'
                        })
                        // console.log(data)
                        .then(data => data.json())
                        .then(function (data) {
                            // console.log(data)
                            data.items.map(function (data) {
                                console.log(data)
                                // console.log ("MATCH (a:`_"+ instance + "_Instance`),(b:`_code`) WHERE b.value = '" + data.label + "'CREATE (a)<-[r:inDataset]-(b)")
                                    let node = document.createElement("p"); // Create a <h1> node
                                    let textnode = document.createTextNode("MATCH (a:`_"+ instance + "_Instance`),(b:`_code`)-[:usedBy]->(cl:`_code_list_" + data.links.code_list.id+ "`) WHERE b.value = '" + data.option + "' CREATE (a)<-[r:inDataset]-(b);"); // Create a text node
                                    node.appendChild(textnode); // Append the text to <h1>
                                    document.getElementById("cypher").appendChild(node);
                            })
                        })


                // writeCypher (data)

            })

    })
    }

    // function writeCypher(data) {

    //     // console.log (data)

    //     // data = data.split(" : ")
    //     // datasetHref = data[0]
    //     // instance = data[1]


    //     // versionWorking = datasetHref.split("/versions/")
    //     // version = versionWorking[1]
    //     // editionWorking = versionWorking[0].split("/editions/")
    //     // edition = editionWorking[1]
    //     // datasetWorking = editionWorking[0].split("/datasets/")
    //     // dataset = datasetWorking[1]
    //     // console.log (datasetHref)
    //     // console.log(dataset + edition + version)




    //     let node = document.createElement("p"); // Create a <h1> node
    //     let textnode = document.createTextNode("MATCH (n:`_" + instance +
    //         "_Instance`) SET n.is_published =true, n.dataset ='" + dataset + "', n.edition ='" + edition +
    //         "', n.version =" + version + ";"); // Create a text node
    //     node.appendChild(textnode); // Append the text to <h1>
    //     document.getElementById("cypher").appendChild(node);

    // }
</script>

</html>