<html>
    <body>
        <!-- <p>CREATE CONSTRAINT ON (n:`_code`) ASSERT n.code IS UNIQUE;</p> -->
        <div id = "cypher"></div>
    </body>

<script>
    // let root = "https://api.dev.cmd.onsdigital.co.uk/v1/code-lists"
    let root = "https://api.beta.ons.gov.uk/v1/code-lists"
    // let root = "http://localhost:23200/v1/code-lists"

    document.addEventListener("DOMContentLoaded", function () {
        fetch(root, {
                mode: 'cors'
            })
            .then(data => data.json())
            .then(function (data) {
                
                data.items.map(function (data) {

                    if (data.name === "geography"){
                        let constraint = document.createTextNode("CREATE CONSTRAINT ON (n:`_code_"+ data.name +"`) ASSERT n.value IS UNIQUE;");
                        codelist = data.links.codes.href
                        getCodes(codelist)
                        let node = document.createElement("p"); 
                        let node2 = document.createElement("p"); 
                        let textnode = document.createTextNode("CREATE (node:`_code_list`:`_code_list_"+data.id+"` { label:'"+ data.name+ "', edition:'one-off' });");
                        node.appendChild(textnode); 
                        node2.appendChild(constraint);
                        document.getElementById("cypher").appendChild(node);
                        document.getElementById("cypher").appendChild(node2);
                    } else {
                        let constraint = document.createTextNode("CREATE CONSTRAINT ON (n:`_code_"+ data.id +"`) ASSERT n.value IS UNIQUE;");     // Create a text node
                        codelist = data.links.codes.href
                        getCodes(codelist)
                        let node = document.createElement("p"); 
                        let node2 = document.createElement("p"); 
                        let textnode = document.createTextNode("CREATE (node:`_code_list`:`_code_list_"+data.id+"` { label:'"+ data.name+ "', edition:'one-off' });");     // Create a text node
                        node.appendChild(textnode); 
                        node2.appendChild(constraint);
                        document.getElementById("cypher").appendChild(node);
                        document.getElementById("cypher").appendChild(node2);
                    }

                        


                })
            })
    })

function getCodes(codelist) {
        fetch(codelist, {
                mode: 'cors'
            })
            .then(data => data.json())
            .then(function (data) {
                // console.log (data)
                data.items.map(function (data) {

                    // console.log (data.id)
                    writeCypher (data)
                    })

            })
        }
    function writeCypher (data){
        // console.log (data.links.code_list.id)
        if (data.links.code_list.id === "mid-year-pop-geography" || data.links.code_list.id === "uk-only" || data.links.code_list.id === "65107A9F-7DA3-4B41-A410-6F6D9FBD68C3" || data.links.code_list.id === "ashe-geography" || data.links.code_list.id === "england-and-wales-only" || data.links.code_list.id === "police-force-geography" || data.links.code_list.id === "wellbeing-geography" || data.links.code_list.id === "ashe-table-8-geography" || data.links.code_list.id === "ashe-table-7-geography"){
        let node = document.createElement("p");                 // Create a <h1> node
        let textnode = document.createTextNode("MERGE (node:`_code`:`_code_geography` { value:'" + data.id.trim() + "' });");     // Create a text node
        node.appendChild(textnode);                              // Append the text to <h1>
        document.getElementById("cypher").appendChild(node);
                        // Create a <h1> node
        let node2 = document.createElement("p"); 
        let text = document.createTextNode("MATCH (parent:`_code_list`:`_code_list_" + data.links.code_list.id.trim() + "`),(node:`_code`:`_code_geography` { value:'" + data.id.trim() + "' }) MERGE (node)-[:usedBy { label:\""+ data.label.trim() + "\"}]->(parent);");     // Create a text node
        node2.appendChild(text);                              // Append the text to <h1>
        document.getElementById("cypher").appendChild(node2);

        } else {
            // let node = document.createElement("p");                 // Create a <h1> node
            // let textnode = document.createTextNode("MATCH (parent:`_code_list`:`_code_list_" + data.links.code_list.id + "`) WITH parent CREATE (node:`_code`:`_code_" + data.links.code_list.id + "` { value:'" + data.id + "' })-[:usedBy { label:\""+ data.label + "\"}]->(parent);");     // Create a text node
            // node.appendChild(textnode);                              // Append the text to <h1>
            // document.getElementById("cypher").appendChild(node);

        let node = document.createElement("p");                 // Create a <h1> node
        let textnode = document.createTextNode("MERGE (node:`_code`:`_code_" + data.links.code_list.id.trim() + "` { value:'" + data.id.trim() + "' });");     // Create a text node
        node.appendChild(textnode);                              // Append the text to <h1>
        document.getElementById("cypher").appendChild(node);
                        // Create a <h1> node
        let node2 = document.createElement("p"); 
        let text = document.createTextNode("MATCH (parent:`_code_list`:`_code_list_" + data.links.code_list.id.trim() + "`),(node:`_code`:`_code_" + data.links.code_list.id.trim() + "` { value:'" + data.id.trim() + "' }) MERGE (node)-[:usedBy { label:\""+ data.label.trim() + "\"}]->(parent);");     // Create a text node
        node2.appendChild(text);                              // Append the text to <h1>
        document.getElementById("cypher").appendChild(node2);
        }

    }
</script>

</html>